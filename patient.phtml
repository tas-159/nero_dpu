<!-- ========== MODAL MODIFIER PATIENT ========== -->
<div class="modal fade" id="modifier" tabindex="-1" aria-labelledby="modifierLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modifierLabel">Modifier Patient</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form method="post" action="edit.php">
        <div class="modal-body">
          <div class="form-group row">
            <label class="col-md-3 col-form-label">Pr√©nom</label>
            <div class="col-md-9">
              <input value="<?= htmlspecialchars($patient["prenom"]) ?>" class="form-control" type="text" name="pnom" required>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label">Nom</label>
            <div class="col-md-9">
              <input value="<?= htmlspecialchars($patient["nom"]) ?>" class="form-control" type="text" name="nom" required>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label">T√©l√©phone</label>
            <div class="col-md-9">
              <input value="<?= htmlspecialchars($patient["numtel"]) ?>" class="form-control" type="tel" name="numtel">
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label">Diagnostique</label>
            <div class="col-md-9">
              <input value="<?= htmlspecialchars($patient["diagnostique"]) ?>" class="form-control" type="text" name="diagnostique">
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label">Correspondance</label>
            <div class="col-md-9">
              <input value="<?= htmlspecialchars($patient["correspondance"]) ?>" class="form-control" type="text" name="correspondance">
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label">Date Naissance</label>
            <div class="col-md-9">
              <input value="<?= $patient["datenai"] ?>" class="form-control" type="date" name="datenaiss">
            </div>
          </div>
          <div class="form-group row">
            <label class="col-md-3 col-form-label">Adresse</label>
            <div class="col-md-9">
              <input value="<?= htmlspecialchars($patient["address"]) ?>" class="form-control" type="text" name="adress">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
          <button type="submit" class="btn btn-warning" name="enregistrer">Mettre √† jour</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========== BREADCRUMB ========== -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="index.php">Home</a></li>
    <li class="breadcrumb-item active">
      Patient <?= strtoupper($patient["nom"]) ?> <?= ucwords($patient["prenom"]) ?>
    </li>
  </ol>
</nav>

<!-- ========== PATIENT INFO CARD ========== -->
<div class="container mb-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">üë§ Patient</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <strong>üë§ Nom:</strong> <?= strtoupper($patient["nom"]) ?> <?= ucwords($patient["prenom"]) ?>
        </div>
        <div class="col-md-4">
          <strong>üìÖ Date Naissance:</strong> <?= $patient["datenai"] ?>
        </div>
        <div class="col-md-4">
          <strong>üìû Correspondance:</strong> <?= htmlspecialchars($patient["correspondance"]) ?>
        </div>
      </div>
      <div class="text-center mt-3">
        <button type="button" class="btn btn-warning text-white" data-toggle="modal" data-target="#modifier">
          ‚úèÔ∏è Modifier
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ========== UPLOAD CARDS ========== -->
<div class="container mb-4">
  <h4>üì§ Ajouter Fichiers</h4>
  <div class="row">
    <!-- Image Upload -->
    <div class="col-md-3 mb-3">
      <div class="card border-info">
        <div class="card-body">
          <h5 class="card-title">üì∑ Image DICOM</h5>
          <form method="POST" enctype="multipart/form-data">
            <input type="file" name="file" class="form-control mb-2" accept="image/*" required>
            <button type="submit" name="upim" class="btn btn-info btn-block">Ajouter</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Document Upload -->
    <div class="col-md-3 mb-3">
      <div class="card border-success">
        <div class="card-body">
          <h5 class="card-title">üìÑ Document</h5>
          <form method="POST" enctype="multipart/form-data">
            <input type="file" name="file" class="form-control mb-2" required>
            <button type="submit" name="updoc" class="btn btn-success btn-block">Ajouter</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Video Upload -->
    <div class="col-md-3 mb-3">
      <div class="card border-warning">
        <div class="card-body">
          <h5 class="card-title">üé• Vid√©o</h5>
          <form method="POST" enctype="multipart/form-data">
            <input type="file" name="file" class="form-control mb-2" accept="video/*" required>
            <button type="submit" name="upvid" class="btn btn-warning btn-block">Ajouter</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Archive Upload -->
    <div class="col-md-3 mb-3">
      <div class="card border-danger">
        <div class="card-body">
          <h5 class="card-title">üì¶ Archive</h5>
          <form method="POST" enctype="multipart/form-data">
            <input type="file" name="file" class="form-control mb-2" accept=".zip,.rar,.7z" required>
            <button type="submit" name="upzip" class="btn btn-danger btn-block">Ajouter</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== DOSSIER MEDICAL TABS ========== -->
<div class="container mb-4">
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">üìã Dossier M√©dical</h5>
    </div>
    <div class="card-body">
      <!-- ========== TAB NAVIGATION ========== -->
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link active" data-toggle="tab" href="#image" role="tab">
            üñºÔ∏è Images
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" data-toggle="tab" href="#document" role="tab">
            üìÑ Documents
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" data-toggle="tab" href="#archive" role="tab">
            üì¶ Archives
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" data-toggle="tab" href="#video" role="tab">
            üé• Vid√©os
          </a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" data-toggle="tab" href="#note" role="tab">
            üí¨ Consultations
          </a>
        </li>
      </ul>

      <!-- ========== TAB CONTENT ========== -->
      <div class="tab-content mt-3">

        <!-- ========== IMAGES TAB ========== -->
        <div id="image" class="tab-pane fade show active" role="tabpanel">
          <div id="imageCarousel" class="carousel slide" data-ride="carousel">
            <div class="carousel-inner">
              <?php
              $images = @scandir($updirim);
              $imageCount = 0;
              if ($images && is_array($images)) {
                foreach ($images as $img) {
                  $ext = strtolower(pathinfo($img, PATHINFO_EXTENSION));
                  if (in_array($ext, ['jpg', 'png', 'jpeg', 'gif'])) {
                    $imageCount++;
                    $active = ($imageCount === 1) ? 'active' : '';
                    $safePath = htmlspecialchars($updirim . $img);
              ?>
                <div class="carousel-item <?= $active ?>">
                  <img src="<?= $safePath ?>" class="d-block w-100" alt="Image <?= $imageCount ?>" style="max-height: 500px; object-fit: contain;">
                </div>
              <?php
                  }
                }
              }
              if ($imageCount === 0) {
                echo '<p class="text-muted text-center mt-4">Aucune image</p>';
              }
              ?>
            </div>
            <?php if ($imageCount > 1): ?>
            <a class="carousel-control-prev" href="#imageCarousel" role="button" data-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </a>
            <a class="carousel-control-next" href="#imageCarousel" role="button" data-slide="next">
              <span class="carousel-control-next-icon"></span>
            </a>
            <?php endif; ?>
          </div>
        </div>

        <!-- ========== DOCUMENTS TAB ========== -->
        <div id="document" class="tab-pane fade" role="tabpanel">
          <div class="row">
            <?php
            $docs = @scandir($updirdoc);
            $docCount = 0;
            if ($docs && is_array($docs)) {
              foreach ($docs as $doc) {
                if ($doc !== '.' && $doc !== '..' && !is_dir($updirdoc . $doc)) {
                  $docCount++;
                  $safePath = htmlspecialchars($updirdoc . $doc);
                  $safeName = htmlspecialchars($doc);
            ?>
              <div class="col-md-4 mb-3">
                <div class="card text-center h-100">
                  <div class="card-body">
                    <i class="fa fa-file-text-o" style="font-size: 2.5rem; color: #0088cc;"></i>
                    <p class="mt-2 small">
                      <a href="<?= $safePath ?>" target="_blank" title="Ouvrir">
                        <?= $safeName ?>
                      </a>
                    </p>
                  </div>
                </div>
              </div>
            <?php
                }
              }
            }
            if ($docCount === 0) {
              echo '<p class="text-muted">Aucun document</p>';
            }
            ?>
          </div>
        </div>

        <!-- ========== ARCHIVES TAB ========== -->
        <div id="archive" class="tab-pane fade" role="tabpanel">
          <div class="row">
            <?php
            $zips = @scandir($updirzip);
            $zipCount = 0;
            if ($zips && is_array($zips)) {
              foreach ($zips as $zip) {
                if ($zip !== '.' && $zip !== '..' && !is_dir($updirzip . $zip)) {
                  $zipCount++;
                  $safePath = htmlspecialchars($updirzip . $zip);
                  $safeName = htmlspecialchars($zip);
            ?>
              <div class="col-md-4 mb-3">
                <div class="card text-center h-100">
                  <div class="card-body">
                    <i class="fa fa-file-archive-o" style="font-size: 2.5rem; color: #ff6b6b;"></i>
                    <p class="mt-2 small">
                      <a href="<?= $safePath ?>" target="_blank" title="T√©l√©charger">
                        <?= $safeName ?>
                      </a>
                    </p>
                  </div>
                </div>
              </div>
            <?php
                }
              }
            }
            if ($zipCount === 0) {
              echo '<p class="text-muted">Aucune archive</p>';
            }
            ?>
          </div>
        </div>

        <!-- ========== VIDEOS TAB ========== -->
        <div id="video" class="tab-pane fade" role="tabpanel">
          <div class="row">
            <?php
            $vids = @scandir($updirvid);
            $vidCount = 0;
            if ($vids && is_array($vids)) {
              foreach ($vids as $vid) {
                if ($vid !== '.' && $vid !== '..' && !is_dir($updirvid . $vid)) {
                  $vidCount++;
                  $safePath = htmlspecialchars($updirvid . $vid);
                  $safeName = htmlspecialchars($vid);
            ?>
              <div class="col-md-6 mb-3">
                <div class="card h-100">
                  <div class="card-body">
                    <video width="100%" height="300" controls style="background: #000;">
                      <source src="<?= $safePath ?>" type="video/mp4">
                      Navigateur non support√©
                    </video>
                    <p class="mt-2 small text-center"><strong><?= $safeName ?></strong></p>
                  </div>
                </div>
              </div>
            <?php
                }
              }
            }
            if ($vidCount === 0) {
              echo '<p class="text-muted">Aucune vid√©o</p>';
            }
            ?>
          </div>
        </div>

        <!-- ========== CONSULTATIONS TAB ========== -->
        <div id="note" class="tab-pane fade" role="tabpanel">
          <a href="add-note.php" class="btn btn-primary mb-3">
            ‚ûï Ajouter Consultation
          </a>
          <div class="row">
            <?php if (count($notes) === 0): ?>
              <div class="col-12">
                <p class="text-muted">Aucune consultation enregistr√©e</p>
              </div>
            <?php else: ?>
              <?php foreach ($notes as $note): ?>
              <div class="col-md-4 mb-3">
                <div class="card h-100">
                  <div class="card-body">
                    <h6 class="card-title">üìÖ <?= date('d/m/Y H:i', strtotime($note["Date"])) ?></h6>
                    <p class="card-text text-truncate"><?= htmlspecialchars(substr($note["Note"], 0, 80)) ?>...</p>
                    
                    <!-- ACTION BUTTONS -->
                    <div class="btn-group btn-group-sm" role="group">
                      <!-- Delete Button -->
                      <button class="btn btn-danger" data-toggle="modal" data-target="#delete-<?= $note['id_note'] ?>" title="Supprimer">
                        üóëÔ∏è
                      </button>
                      
                      <!-- Edit Button -->
                      <a href="update_consultation.php?noteId=<?= $note['id_note'] ?>" class="btn btn-warning" title="Modifier">
                        ‚úèÔ∏è
                      </a>
                      
                      <!-- View Button -->
                      <button class="btn btn-primary" data-toggle="modal" data-target="#view-<?= $note['id_note'] ?>" title="Voir">
                        üëÅÔ∏è
                      </button>
                      
                      <!-- CDA View Button -->
                      <a href="view_cda.php?noteId=<?= $note['id_note'] ?>" class="btn btn-info" target="_blank" title="Voir CDA">
                        üìã
                      </a>
                      
                      <!-- CDA Download Button -->
                      <a href="generate_cda.php?noteId=<?= $note['id_note'] ?>" class="btn btn-success" title="T√©l√©charger XML">
                        üì•
                      </a>
                    </div>
                  </div>
                </div>

                <!-- ========== VIEW MODAL ========== -->
                <div class="modal fade" id="view-<?= $note['id_note'] ?>" tabindex="-1">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Consultation du <?= $note["Date"] ?></h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                      </div>
                      <div class="modal-body">
                        <p><?= nl2br(htmlspecialchars($note["Note"])) ?></p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- ========== DELETE MODAL ========== -->
                <div class="modal fade" id="delete-<?= $note['id_note'] ?>" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">‚ö†Ô∏è Supprimer Consultation</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                      </div>
                      <div class="modal-body">
                        <p>√ätes-vous s√ªr de vouloir supprimer cette consultation?</p>
                        <p class="text-muted small">Cette action est irr√©versible.</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                        <a href="delete-note.php?id=<?= $note['id_note'] ?>" class="btn btn-danger">
                          Supprimer
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <?php endforeach; ?>
            <?php endif; ?>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ========== FOOTER ========== -->
<script>
$(document).ready(function() {
  // Auto-fill filename
  $(".custom-file-input").on("change", function() {
    var fileName = $(this).val().split("\\").pop();
    $(this).siblings(".custom-file-label").html(fileName);
  });
});
</script>
